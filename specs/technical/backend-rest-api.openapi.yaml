openapi: 3.1.0
info:
  title: Factly Backend REST API
  version: 1.0.0
  description: HTTP REST API for room-based discovery session management.
  x-tsid: TS-BackendRestApi
  x-fsid-links:
    - FS-CreateRoom
    - FS-RetrieveRoom
    - FS-DeleteRoom
    - FS-GetServerStatus
    - FS-SendUpdateToRoom
    - FS-RejectEmptyRoomBody
    - FS-RejectMissingRequiredFields
    - FS-RejectInvalidFieldTypes
    - FS-RejectInvalidUpdateBody
    - FS-RejectInvalidRoomIdFormat
    - FS-ReturnStructuredErrorResponse
    - FS-TriggerFactsExtraction
    - FS-DisplaySuggestedFacts
    - FS-ExtractionErrorDisplay
    - FS-TriggerInsightsExtraction
    - FS-DisplaySuggestedInsights
    - FS-InsightsExtractionErrorDisplay

servers:
  - url: http://localhost:3002
    description: Local development server

paths:
  /rooms:
    post:
      operationId: createRoom
      summary: Create a new room with discovery data
      x-tsid: TS-CreateRoom
      x-fsid-links:
        - FS-CreateRoom
        - FS-RejectEmptyRoomBody
        - FS-RejectMissingRequiredFields
        - FS-RejectInvalidFieldTypes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DiscoveryData'
      responses:
        '200':
          description: Room created successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - roomId
                properties:
                  roomId:
                    type: string
                    format: uuid
                    description: UUID v4 identifier for the created room
                    example: "550e8400-e29b-41d4-a716-446655440000"
        '400':
          description: Validation error (empty body, missing fields, or invalid field types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /rooms/{id}:
    get:
      operationId: getRoom
      summary: Retrieve room data by ID
      x-tsid: TS-GetRoom
      x-fsid-links:
        - FS-RetrieveRoom
        - FS-RejectInvalidRoomIdFormat
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Room data retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiscoveryData'
        '400':
          description: Invalid room ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      operationId: deleteRoom
      summary: Stop and delete a room
      description: Deletes the room's subscribers and users from memory and removes persisted data.
      x-tsid: TS-DeleteRoom
      x-fsid-links:
        - FS-DeleteRoom
        - FS-RejectInvalidRoomIdFormat
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Room stopped and deleted
        '400':
          description: Invalid room ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /rooms/{id}/update:
    post:
      operationId: updateRoom
      summary: Send a discovery data update to a room
      description: Receives an update payload with discovery data, sender UUID, and username. Saves and broadcasts to subscribers.
      x-tsid: TS-UpdateRoom
      x-fsid-links:
        - FS-SendUpdateToRoom
        - FS-BroadcastUpdateToSubscribers
        - FS-RejectInvalidUpdateBody
        - FS-RejectInvalidRoomIdFormat
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - payload
                - senderUuid
                - username
              properties:
                payload:
                  $ref: '#/components/schemas/DiscoveryData'
                senderUuid:
                  type: string
                  description: UUID of the sender
                username:
                  type: string
                  description: Username of the sender
      responses:
        '204':
          description: Update received and broadcast
        '400':
          description: Validation error (invalid room ID, missing fields, or invalid types)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /extract/facts:
    post:
      operationId: extractFacts
      summary: Extract facts from text input using AI
      description: Sends input text and discovery goal to an LLM provider to extract relevant facts. Returns suggested fact texts for analyst validation.
      x-tsid: TS-ExtractFacts
      x-fsid-links:
        - FS-TriggerFactsExtraction
        - FS-DisplaySuggestedFacts
        - FS-ExtractionErrorDisplay
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - input_text
                - goal
                - input_id
              properties:
                input_text:
                  type: string
                  minLength: 1
                  description: The text content of the Input to extract facts from
                goal:
                  type: string
                  minLength: 1
                  description: The Discovery goal used as extraction context
                input_id:
                  type: string
                  description: The input_id of the source Input
      responses:
        '200':
          description: Extraction successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractionResponse'
        '400':
          description: Validation error (missing or invalid fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: LLM provider error (timeout, invalid response)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Extraction service not configured (missing LLM_PROVIDER or LLM_API_KEY)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /extract/insights:
    post:
      operationId: extractInsights
      summary: Extract insights from selected facts using AI
      description: Sends fact texts and discovery goal to an LLM provider to derive relevant insights. Returns suggested insight texts for analyst validation.
      x-tsid: TS-ExtractInsights
      x-fsid-links:
        - FS-TriggerInsightsExtraction
        - FS-DisplaySuggestedInsights
        - FS-InsightsExtractionErrorDisplay
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - facts
                - goal
              properties:
                facts:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - fact_id
                      - text
                    properties:
                      fact_id:
                        type: string
                        description: The fact_id of the source Fact
                      text:
                        type: string
                        minLength: 1
                        description: The text content of the Fact
                  description: The selected facts to derive insights from
                goal:
                  type: string
                  minLength: 1
                  description: The Discovery goal used as extraction context
      responses:
        '200':
          description: Extraction successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InsightsExtractionResponse'
        '400':
          description: Validation error (missing or invalid fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          description: LLM provider error (timeout, invalid response)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Extraction service not configured (missing LLM_PROVIDER or LLM_API_KEY)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /status:
    get:
      operationId: getStatus
      summary: Get connected client count per room
      x-tsid: TS-GetServerStatus
      x-fsid-links:
        - FS-GetServerStatus
      responses:
        '200':
          description: Map of room IDs to connected client counts
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: integer
                  description: Number of connected SSE clients
                example:
                  "550e8400-e29b-41d4-a716-446655440000": 3
                  "660e8400-e29b-41d4-a716-446655440001": 1

components:
  schemas:
    DiscoveryData:
      type: object
      required:
        - discovery_id
        - title
        - goal
        - date
        - inputs
        - facts
        - insights
        - recommendations
        - outputs
      properties:
        discovery_id:
          type: string
          description: Unique identifier for the discovery
        title:
          type: string
        goal:
          type: string
        date:
          type: string
          format: date
        inputs:
          type: array
          items:
            $ref: '#/components/schemas/Input'
        facts:
          type: array
          items:
            $ref: '#/components/schemas/Fact'
        insights:
          type: array
          items:
            $ref: '#/components/schemas/Insight'
        recommendations:
          type: array
          items:
            $ref: '#/components/schemas/Recommendation'
        outputs:
          type: array
          items:
            $ref: '#/components/schemas/Output'

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message
          example: "Field \"title\" is required and must be a string"

    Input:
      type: object
      required:
        - input_id
        - type
        - title
      properties:
        input_id:
          type: string
        type:
          type: string
          enum: [text, web, image, video, audio, pdf, csv]
        title:
          type: string
        url:
          type: string
          format: uri
        text:
          type: string

    Fact:
      type: object
      required:
        - fact_id
        - related_inputs
        - text
      properties:
        fact_id:
          type: string
        related_inputs:
          type: array
          items:
            type: string
          description: List of input_id references
        text:
          type: string

    Insight:
      type: object
      required:
        - insight_id
        - related_facts
        - text
      properties:
        insight_id:
          type: string
        related_facts:
          type: array
          items:
            type: string
          description: List of fact_id references
        text:
          type: string

    Recommendation:
      type: object
      required:
        - recommendation_id
        - related_insights
        - text
      properties:
        recommendation_id:
          type: string
        related_insights:
          type: array
          items:
            type: string
          description: List of insight_id references
        text:
          type: string

    Output:
      type: object
      required:
        - output_id
        - related_recommendations
        - text
      properties:
        output_id:
          type: string
        related_recommendations:
          type: array
          items:
            type: string
          description: List of recommendation_id references
        text:
          type: string

    InsightsExtractionResponse:
      type: object
      required:
        - suggestions
        - fact_ids
      properties:
        suggestions:
          type: array
          items:
            type: object
            required:
              - text
            properties:
              text:
                type: string
                description: A suggested insight text derived by the LLM
          description: List of suggested insights for analyst validation
        fact_ids:
          type: array
          items:
            type: string
          description: The fact_ids of the source Facts used for extraction

    ExtractionResponse:
      type: object
      required:
        - suggestions
        - input_id
      properties:
        suggestions:
          type: array
          items:
            type: object
            required:
              - text
            properties:
              text:
                type: string
                description: A suggested fact text extracted by the LLM
          description: List of suggested facts for analyst validation
        input_id:
          type: string
          description: The input_id of the source Input
